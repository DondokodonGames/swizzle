// src/social/components/LikeButton.tsx

import React, { useState, useCallback, useEffect, useRef, useMemo } from 'react';
import { ModernButton } from '../../components/ui/ModernButton';
import { SocialService } from '../services/SocialService';
import { SocialStats, SocialState } from '../types/SocialTypes';

interface LikeButtonProps {
  gameId: string;
  initialStats: SocialStats;
  initialState?: Partial<SocialState>;
  onLike?: (gameId: string, isLiked: boolean) => void;
  onShare?: (gameId: string) => void;
  onBookmark?: (gameId: string, isBookmarked: boolean) => void;
  onView?: (gameId: string) => void;
  className?: string;
  compact?: boolean;
  showLabels?: boolean;
  animated?: boolean;
}

// „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö
const ANIMATION_DURATION = 300;
const HEART_PARTICLES_COUNT = 6;

export const LikeButton: React.FC<LikeButtonProps> = ({
  gameId,
  initialStats,
  initialState = {},
  onLike,
  onShare,
  onBookmark,
  onView,
  className = '',
  compact = false,
  showLabels = true,
  animated = true
}) => {
  // Áä∂ÊÖãÁÆ°ÁêÜ
  const [stats, setStats] = useState<SocialStats>(initialStats);
  const [state, setState] = useState<SocialState>({
    isLiked: initialState.isLiked || false,
    isShared: initialState.isShared || false,
    isBookmarked: initialState.isBookmarked || false
  });
  const [isAnimating, setIsAnimating] = useState(false);
  const [showShareMenu, setShowShareMenu] = useState(false);
  const [particleKey, setParticleKey] = useState(0);

  // „É™„Éï„Ç°„É¨„É≥„Çπ
  const likeButtonRef = useRef<HTMLButtonElement>(null);
  const shareMenuRef = useRef<HTMLDivElement>(null);

  // „Çµ„Éº„Éì„Çπ„Ç§„É≥„Çπ„Çø„É≥„Çπ
  const socialService = useMemo(() => SocialService.getInstance(), []);

  // „ÅÑ„ÅÑ„Å≠Âá¶ÁêÜ
  const handleLike = useCallback(async () => {
    if (isAnimating) return;

    try {
      setIsAnimating(true);
      const newLikedState = !state.isLiked;
      
      // Ê•ΩË¶≥ÁöÑÊõ¥Êñ∞
      setState(prev => ({ ...prev, isLiked: newLikedState }));
      setStats(prev => ({
        ...prev,
        likes: prev.likes + (newLikedState ? 1 : -1)
      }));

      // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú
      if (animated && newLikedState) {
        setParticleKey(prev => prev + 1);
      }

      // API„Ç≥„Éº„É´
      const result = await socialService.toggleLike(gameId, 'current-user');
      
      // ÂÆüÈöõ„ÅÆÁµêÊûú„ÅßÊõ¥Êñ∞
      setState(prev => ({ ...prev, isLiked: result.isLiked }));
      setStats(prev => ({ ...prev, likes: result.newCount }));

      // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØÂÆüË°å
      onLike?.(gameId, result.isLiked);

    } catch (error) {
      // „Ç®„É©„ÉºÊôÇ„ÅØ„É≠„Éº„É´„Éê„ÉÉ„ÇØ
      setState(prev => ({ ...prev, isLiked: !state.isLiked }));
      setStats(prev => ({
        ...prev,
        likes: prev.likes + (state.isLiked ? 1 : -1)
      }));
      console.error('Like error:', error);
    } finally {
      setTimeout(() => setIsAnimating(false), ANIMATION_DURATION);
    }
  }, [gameId, state.isLiked, isAnimating, animated, onLike, socialService]);

  // „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØÂá¶ÁêÜ
  const handleBookmark = useCallback(async () => {
    try {
      const newBookmarkedState = !state.isBookmarked;
      
      // Ê•ΩË¶≥ÁöÑÊõ¥Êñ∞
      setState(prev => ({ ...prev, isBookmarked: newBookmarkedState }));
      setStats(prev => ({
        ...prev,
        bookmarks: prev.bookmarks + (newBookmarkedState ? 1 : -1)
      }));

      // API„Ç≥„Éº„É´
      const result = await socialService.toggleBookmark(gameId, 'current-user');
      
      // ÂÆüÈöõ„ÅÆÁµêÊûú„ÅßÊõ¥Êñ∞
      setState(prev => ({ ...prev, isBookmarked: result.isBookmarked }));
      setStats(prev => ({ ...prev, bookmarks: result.newCount }));

      onBookmark?.(gameId, result.isBookmarked);

    } catch (error) {
      // „Ç®„É©„ÉºÊôÇ„ÅØ„É≠„Éº„É´„Éê„ÉÉ„ÇØ
      setState(prev => ({ ...prev, isBookmarked: !state.isBookmarked }));
      setStats(prev => ({
        ...prev,
        bookmarks: prev.bookmarks + (state.isBookmarked ? 1 : -1)
      }));
      console.error('Bookmark error:', error);
    }
  }, [gameId, state.isBookmarked, onBookmark, socialService]);

  // „Ç∑„Çß„Ç¢Âá¶ÁêÜ
  const handleShare = useCallback(async (platform?: string) => {
    try {
      const gameUrl = `${window.location.origin}/game/${gameId}`;
      
      if (platform === 'native' && navigator.share) {
        // „Éç„Ç§„ÉÜ„Ç£„Éñ„Ç∑„Çß„Ç¢
        await navigator.share({
          title: '„Ç≤„Éº„É†„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºÅ',
          text: 'Èù¢ÁôΩ„ÅÑ„Ç≤„Éº„É†„ÇíË¶ã„Å§„Åë„Åæ„Åó„Åü',
          url: gameUrl
        });
      } else if (platform === 'copy') {
        // URL„Ç≥„Éî„Éº
        await navigator.clipboard.writeText(gameUrl);
        alert('URL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
      } else if (platform) {
        // SNS„Ç∑„Çß„Ç¢
        const shareUrls = {
          twitter: `https://twitter.com/intent/tweet?url=${encodeURIComponent(gameUrl)}&text=${encodeURIComponent('Èù¢ÁôΩ„ÅÑ„Ç≤„Éº„É†„ÇíË¶ã„Å§„Åë„Åæ„Åó„ÅüÔºÅ')}`,
          facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(gameUrl)}`,
          line: `https://line.me/R/msg/text/?${encodeURIComponent('Èù¢ÁôΩ„ÅÑ„Ç≤„Éº„É†„ÇíË¶ã„Å§„Åë„Åæ„Åó„ÅüÔºÅ ' + gameUrl)}`
        };
        
        const url = shareUrls[platform as keyof typeof shareUrls];
        if (url) {
          window.open(url, '_blank', 'width=600,height=400');
        }
      } else {
        // „Ç∑„Çß„Ç¢„É°„Éã„É•„Éº„ÇíË°®Á§∫
        setShowShareMenu(!showShareMenu);
        return;
      }

      // „Ç∑„Çß„Ç¢Áµ±Ë®à„ÇíÊõ¥Êñ∞
      if (platform) {
        const newShareCount = await socialService.recordShare(gameId, platform, 'current-user');
        setStats(prev => ({ ...prev, shares: newShareCount }));
        setState(prev => ({ ...prev, isShared: true }));
        setShowShareMenu(false);
        onShare?.(gameId);
      }

    } catch (error) {
      console.error('Share error:', error);
    }
  }, [gameId, showShareMenu, onShare, socialService]);

  // Â§ñÈÉ®„ÇØ„É™„ÉÉ„ÇØ„Åß„Ç∑„Çß„Ç¢„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (shareMenuRef.current && !shareMenuRef.current.contains(event.target as Node)) {
        setShowShareMenu(false);
      }
    };

    if (showShareMenu) {
      document.addEventListener('mousedown', handleClickOutside);
      return () => document.removeEventListener('mousedown', handleClickOutside);
    }
  }, [showShareMenu]);

  // „Éì„É•„ÉºÊï∞„Ç´„Ç¶„É≥„ÉàÔºà„Éû„Ç¶„É≥„ÉàÊôÇ„Å´1Âõû„Å†„ÅëÔºâ
  useEffect(() => {
    if (onView) {
      onView(gameId);
      socialService.incrementViews(gameId).then(newViewCount => {
        setStats(prev => ({ ...prev, views: newViewCount }));
      });
    }
  }, [gameId, onView, socialService]);

  // Êï∞ÂÄ§„Éï„Ç©„Éº„Éû„ÉÉ„Éà
  const formatCount = useCallback((count: number): string => {
    if (count >= 1000000) return `${(count / 1000000).toFixed(1)}M`;
    if (count >= 1000) return `${(count / 1000).toFixed(1)}K`;
    return count.toString();
  }, []);

  return (
    <div className={`like-button-container relative ${className}`}>
      <div className={`flex items-center gap-2 ${compact ? 'gap-1' : 'gap-2'}`}>
        
        {/* „ÅÑ„ÅÑ„Å≠„Éú„Çø„É≥ */}
        <div className="relative">
          <ModernButton
            ref={likeButtonRef}
            onClick={handleLike}
            disabled={isAnimating}
            className={`relative transition-all duration-300 ${
              state.isLiked 
                ? 'bg-red-500 hover:bg-red-600 text-white shadow-lg scale-105' 
                : 'bg-gray-100 hover:bg-gray-200 text-gray-600 hover:text-red-500'
            } ${compact ? 'px-2 py-1 text-sm' : 'px-3 py-2'} ${
              isAnimating ? 'animate-pulse' : ''
            }`}
            style={{
              transform: animated && state.isLiked ? 'scale(1.1)' : 'scale(1)',
              transition: 'all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55)'
            }}
          >
            <span className={`transition-transform duration-300 ${
              state.isLiked ? 'animate-bounce' : ''
            }`}>
              {state.isLiked ? '‚ù§Ô∏è' : 'ü§ç'}
            </span>
            {showLabels && (
              <span className="ml-1 font-medium">
                {formatCount(stats.likes)}
              </span>
            )}
          </ModernButton>

          {/* „Éè„Éº„Éà„Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÂäπÊûú */}
          {animated && state.isLiked && (
            <div key={particleKey} className="absolute inset-0 pointer-events-none">
              {Array.from({ length: HEART_PARTICLES_COUNT }).map((_, i) => (
                <div
                  key={i}
                  className="absolute text-red-500 text-xs animate-ping"
                  style={{
                    left: `${20 + Math.random() * 60}%`,
                    top: `${20 + Math.random() * 60}%`,
                    animationDelay: `${i * 50}ms`,
                    animationDuration: '1s'
                  }}
                >
                  ‚ù§Ô∏è
                </div>
              ))}
            </div>
          )}
        </div>

        {/* „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Éú„Çø„É≥ */}
        <ModernButton
          onClick={handleBookmark}
          className={`transition-all duration-300 ${
            state.isBookmarked 
              ? 'bg-yellow-500 hover:bg-yellow-600 text-white' 
              : 'bg-gray-100 hover:bg-gray-200 text-gray-600 hover:text-yellow-500'
          } ${compact ? 'px-2 py-1 text-sm' : 'px-3 py-2'}`}
        >
          {state.isBookmarked ? '‚≠ê' : '‚òÜ'}
          {showLabels && (
            <span className="ml-1 font-medium">
              {formatCount(stats.bookmarks)}
            </span>
          )}
        </ModernButton>

        {/* „Ç∑„Çß„Ç¢„Éú„Çø„É≥ */}
        <div className="relative" ref={shareMenuRef}>
          <ModernButton
            onClick={() => handleShare()}
            className={`transition-all duration-300 ${
              state.isShared 
                ? 'bg-blue-500 hover:bg-blue-600 text-white' 
                : 'bg-gray-100 hover:bg-gray-200 text-gray-600 hover:text-blue-500'
            } ${compact ? 'px-2 py-1 text-sm' : 'px-3 py-2'}`}
          >
            üì§
            {showLabels && (
              <span className="ml-1 font-medium">
                {formatCount(stats.shares)}
              </span>
            )}
          </ModernButton>

          {/* „Ç∑„Çß„Ç¢„É°„Éã„É•„Éº */}
          {showShareMenu && (
            <div className="absolute top-full left-0 mt-2 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-50 min-w-[200px] animate-in slide-in-from-top-2 duration-200">
              <div className="px-3 py-1 text-xs text-gray-500 border-b border-gray-100 mb-1">
                „Ç∑„Çß„Ç¢ÂÖà„ÇíÈÅ∏Êäû
              </div>
              
              {/* „Éç„Ç§„ÉÜ„Ç£„Éñ„Ç∑„Çß„Ç¢ÔºàÂØæÂøú„Éá„Éê„Ç§„Çπ„ÅÆ„ÅøÔºâ */}
              {'share' in navigator && (
                <button
                  onClick={() => handleShare('native')}
                  className="w-full px-3 py-2 text-left hover:bg-gray-50 flex items-center gap-2"
                >
                  üì± „Éá„Éê„Ç§„Çπ„ÅÆ„Ç∑„Çß„Ç¢Ê©üËÉΩ
                </button>
              )}

              {/* SNS„Ç∑„Çß„Ç¢ */}
              <button
                onClick={() => handleShare('twitter')}
                className="w-full px-3 py-2 text-left hover:bg-gray-50 flex items-center gap-2"
              >
                üê¶ Twitter „Åß„Ç∑„Çß„Ç¢
              </button>
              <button
                onClick={() => handleShare('facebook')}
                className="w-full px-3 py-2 text-left hover:bg-gray-50 flex items-center gap-2"
              >
                üë§ Facebook „Åß„Ç∑„Çß„Ç¢
              </button>
              <button
                onClick={() => handleShare('line')}
                className="w-full px-3 py-2 text-left hover:bg-gray-50 flex items-center gap-2"
              >
                üí¨ LINE „Åß„Ç∑„Çß„Ç¢
              </button>
              
              <div className="border-t border-gray-100 mt-1 pt-1">
                <button
                  onClick={() => handleShare('copy')}
                  className="w-full px-3 py-2 text-left hover:bg-gray-50 flex items-center gap-2"
                >
                  üìã URL„Çí„Ç≥„Éî„Éº
                </button>
              </div>
            </div>
          )}
        </div>

        {/* „Éì„É•„ÉºÊï∞Ôºàcompact‰ª•Â§ñ„ÅßË°®Á§∫Ôºâ */}
        {!compact && showLabels && (
          <div className="text-sm text-gray-500 flex items-center gap-1">
            <span>üëÅÔ∏è</span>
            <span>{formatCount(stats.views || 0)}</span>
          </div>
        )}
      </div>

      {/* „Ç≥„É≥„Éë„ÇØ„ÉàÊôÇ„ÅÆÁµ±Ë®à„Çµ„Éû„É™„Éº */}
      {compact && showLabels && (
        <div className="text-xs text-gray-500 mt-1 flex items-center gap-3">
          <span>üëÅÔ∏è {formatCount(stats.views || 0)}</span>
          <span>‚ù§Ô∏è {formatCount(stats.likes)}</span>
          <span>üì§ {formatCount(stats.shares)}</span>
        </div>
      )}
    </div>
  );
};

// „É¨„Éº„ÉÜ„Ç£„É≥„Ç∞Ê©üËÉΩ‰ªò„Åç„Éê„Éº„Ç∏„Éß„É≥
interface RatingButtonProps extends Omit<LikeButtonProps, 'initialStats'> {
  initialRating: number;
  maxRating?: number;
  onRate?: (gameId: string, rating: number) => void;
}

export const RatingButton: React.FC<RatingButtonProps> = ({
  gameId,
  initialRating,
  maxRating = 5,
  onRate,
  className = '',
  ...props
}) => {
  const [rating, setRating] = useState(initialRating);
  const [hoverRating, setHoverRating] = useState(0);

  const handleRate = useCallback((newRating: number) => {
    setRating(newRating);
    onRate?.(gameId, newRating);
    console.log(`${gameId}: Ë©ï‰æ° ${newRating}/${maxRating}`);
  }, [gameId, maxRating, onRate]);

  return (
    <div className={`rating-button ${className}`}>
      <div className="flex items-center gap-1">
        {Array.from({ length: maxRating }).map((_, i) => {
          const starValue = i + 1;
          const isActive = starValue <= (hoverRating || rating);
          
          return (
            <button
              key={i}
              onClick={() => handleRate(starValue)}
              onMouseEnter={() => setHoverRating(starValue)}
              onMouseLeave={() => setHoverRating(0)}
              className={`text-2xl transition-all duration-200 hover:scale-110 ${
                isActive ? 'text-yellow-500' : 'text-gray-300 hover:text-yellow-400'
              }`}
            >
              {isActive ? '‚≠ê' : '‚òÜ'}
            </button>
          );
        })}
        <span className="ml-2 text-sm text-gray-600">
          {rating.toFixed(1)} / {maxRating}
        </span>
      </div>
    </div>
  );
};