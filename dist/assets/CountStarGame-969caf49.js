var F=Object.defineProperty;var C=(h,n,s)=>n in h?F(h,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):h[n]=s;var o=(h,n,s)=>(C(h,typeof n!="symbol"?n+"":n,s),s);import{G as R,C as b,a as T,b as g}from"./index-a4c7ba8a.js";function B(h){return h==="easy"||h==="normal"||h==="hard"}function W(h){const n=h.difficulty;return B(n)?n:"normal"}function H(h,n){return typeof h=="number"&&isFinite(h)?Math.max(1e3,Math.round(h*1e3)):n}function m(h,n,s){return Math.max(n,Math.min(s,h))}function A(h){for(let n=h.length-1;n>0;n--){const s=Math.random()*(n+1)|0;[h[n],h[s]]=[h[s],h[n]]}return h}function v(h,n){h.includes(n)||h.push(n)}class P extends R{constructor(s,i){super(s,i);o(this,"onGameEnd");o(this,"scene",new b);o(this,"finished",!1);o(this,"remainMs",3e4);o(this,"titleText");o(this,"infoText");o(this,"timeBar");o(this,"tiles",[]);o(this,"starsLayer",new b);o(this,"cols",2);o(this,"rows",2);o(this,"tileW",160);o(this,"tileH",110);o(this,"gapX",18);o(this,"gapY",14);o(this,"phase","show");o(this,"phaseRemain",0);o(this,"roundsNeeded",8);o(this,"roundsDone",0);o(this,"optionsCount",4);o(this,"missesAllowed",3);o(this,"misses",0);o(this,"showTimeMs",1100);o(this,"answerTimeMs",2600);o(this,"minStars",5);o(this,"maxStars",14);o(this,"currentCount",0);o(this,"correctIndex",0);o(this,"score",0);o(this,"combo",0);o(this,"colors",{bgTop:725024,bgBottom:1382955,star:16773542,starAlt:16777215,tile:16777215,tileText:1776411,good:9627303,bad:16734810,barBack:3621201,barFill:3900150,text:16777215})}async createScene(){const s=this.settings,i=W(s),t=this.app.renderer.width,e=this.app.renderer.height;this.remainMs=H(s.duration,3e4),i==="easy"?(this.roundsNeeded=6,this.optionsCount=3,this.missesAllowed=4,this.showTimeMs=1400,this.answerTimeMs=3e3,this.minStars=3,this.maxStars=10):i==="hard"?(this.roundsNeeded=10,this.optionsCount=5,this.missesAllowed=2,this.showTimeMs=900,this.answerTimeMs=2200,this.minStars=8,this.maxStars=18):(this.roundsNeeded=8,this.optionsCount=4,this.missesAllowed=3,this.showTimeMs=1100,this.answerTimeMs=2600,this.minStars=5,this.maxStars=14),typeof s.rounds=="number"&&isFinite(s.rounds)&&(this.roundsNeeded=m(Math.round(s.rounds),3,30)),typeof s.options=="number"&&isFinite(s.options)&&(this.optionsCount=m(Math.round(s.options),3,6)),typeof s.missesAllowed=="number"&&isFinite(s.missesAllowed)&&(this.missesAllowed=m(Math.round(s.missesAllowed),0,10)),typeof s.showTimeMs=="number"&&isFinite(s.showTimeMs)&&(this.showTimeMs=m(Math.round(s.showTimeMs),400,5e3)),typeof s.answerTimeMs=="number"&&isFinite(s.answerTimeMs)&&(this.answerTimeMs=m(Math.round(s.answerTimeMs),1e3,8e3)),typeof s.minStars=="number"&&isFinite(s.minStars)&&(this.minStars=m(Math.round(s.minStars),1,40)),typeof s.maxStars=="number"&&isFinite(s.maxStars)&&(this.maxStars=m(Math.round(s.maxStars),Math.max(2,this.minStars+1),60)),s.palette==="forest"?(this.colors.bgTop=732704,this.colors.bgBottom=201999,this.colors.barFill=3462041):s.palette==="sunset"?(this.colors.bgTop=3152180,this.colors.bgBottom=1706782,this.colors.barFill=16739179):s.palette==="night"&&(this.colors.bgTop=725024,this.colors.bgBottom=1382955,this.colors.barFill=3900150);const r=new T;r.beginFill(this.colors.bgTop),r.drawRect(0,0,t,Math.floor(e*.45)),r.endFill(),r.beginFill(this.colors.bgBottom),r.drawRect(0,Math.floor(e*.45),t,e),r.endFill(),this.scene.addChild(r),this.titleText=new g("Count the Stars!",{fontFamily:"sans-serif",fontSize:Math.floor(Math.min(t,e)*.06),fill:this.colors.text,stroke:0,strokeThickness:5}),this.titleText.anchor.set(.5),this.titleText.x=t/2,this.titleText.y=Math.floor(e*.2),this.scene.addChild(this.titleText),this.infoText=new g("",{fontFamily:"sans-serif",fontSize:Math.floor(Math.min(t,e)*.045),fill:this.colors.text,stroke:0,strokeThickness:4}),this.infoText.anchor.set(.5),this.infoText.x=t/2,this.infoText.y=Math.floor(e*.28),this.scene.addChild(this.infoText),this.updateInfo(),this.timeBar=new T,this.scene.addChild(this.timeBar),this.starsLayer.y=Math.floor(e*.36),this.scene.addChild(this.starsLayer),this.cols=Math.ceil(Math.sqrt(this.optionsCount)),this.rows=Math.ceil(this.optionsCount/this.cols);const a=t-80,u=e-Math.floor(e*.5)-40;this.tileW=Math.min(200,Math.floor(a/this.cols)-16),this.tileH=Math.min(120,Math.floor(u/this.rows)-16),this.gapX=Math.max(12,Math.floor((a-this.cols*this.tileW)/(this.cols+1))),this.gapY=Math.max(10,Math.floor((u-this.rows*this.tileH)/(this.rows+1)));const p=Math.floor(e*.56),f=(t-(this.cols*this.tileW+(this.cols-1)*this.gapX))/2+this.tileW/2;for(let c=0;c<this.optionsCount;c++){const l=new b,d=new T;d.beginFill(this.colors.tile,.96),d.drawRoundedRect(-this.tileW/2,-this.tileH/2,this.tileW,this.tileH,16),d.endFill();const M=new g("",{fontFamily:"sans-serif",fontSize:Math.floor(this.tileH*.44),fill:this.colors.tileText});M.anchor.set(.5),l.addChild(d,M),l.eventMode="static";const w=c;l.on("pointertap",S=>{S.stopPropagation(),this.onTap(w)});const x=c%this.cols,y=Math.floor(c/this.cols);l.x=f+x*(this.tileW+this.gapX),l.y=p+y*(this.tileH+this.gapY),l.visible=!1,this.scene.addChild(l),this.tiles.push({root:l,bg:d,label:M,index:w,value:0})}this.container.addChild(this.scene),this.nextRound(!0)}handleInput(s){}updateGame(s){if(this.finished)return;const i=s*(1e3/60);if(this.remainMs-=i,this.remainMs<=0){this.remainMs=0,this.finish(this.roundsDone>=this.roundsNeeded);return}this.phaseRemain-=i,this.phaseRemain<=0&&(this.phase==="show"?this.switchToAnswer():this.registerMiss("timeout")),this.drawPhaseBar()}showResult(s){var i;(i=this.onGameEnd)==null||i.call(this,s.success,s.score)}updateInfo(){const s=Math.ceil(this.remainMs/1e3);this.infoText.text=`Round ${this.roundsDone}/${this.roundsNeeded}   Miss ${this.misses}/${this.missesAllowed}   Time ${s}s`}drawPhaseBar(){const s=this.app.renderer.width,i=Math.floor(this.app.renderer.height*.33),t=Math.floor(s*.7),e=Math.floor((s-t)/2),r=10,a=this.phase==="show"?this.showTimeMs:this.answerTimeMs,u=m(this.phaseRemain/a,0,1);this.timeBar.clear(),this.timeBar.beginFill(this.colors.barBack,.4),this.timeBar.drawRoundedRect(e,i,t,r,6),this.timeBar.endFill(),this.timeBar.beginFill(this.colors.barFill,.95),this.timeBar.drawRoundedRect(e,i,Math.floor(t*u),r,6),this.timeBar.endFill()}nextRound(s=!1){const i=this.minStars+Math.floor(Math.random()*(this.maxStars-this.minStars+1));this.currentCount=i,this.starsLayer.removeChildren(),this.drawStars(i);for(const t of this.tiles)t.root.visible=!1;this.phase="show",this.phaseRemain=this.showTimeMs,this.drawPhaseBar(),s||this.updateInfo()}switchToAnswer(){this.starsLayer.visible=!1;const s=[this.currentCount];for(;s.length<this.optionsCount;){const i=(Math.random()*5|0)-2;let t=this.currentCount+(i===0?3:i);t=m(t,Math.max(1,this.minStars),this.maxStars+4),v(s,t)}A(s),this.correctIndex=s.indexOf(this.currentCount);for(let i=0;i<this.tiles.length;i++){const t=this.tiles[i];t.value=s[i]??0,t.label.text=String(t.value),t.bg.clear(),t.bg.beginFill(this.colors.tile,.96),t.bg.drawRoundedRect(-this.tileW/2,-this.tileH/2,this.tileW,this.tileH,16),t.bg.endFill(),t.root.visible=!0}this.phase="answer",this.phaseRemain=this.answerTimeMs,this.drawPhaseBar()}onTap(s){if(this.finished||this.phase!=="answer")return;if(s===this.correctIndex){this.roundsDone++,this.combo++;const t=m(this.phaseRemain/this.answerTimeMs,0,1),e=300,r=Math.min(7,this.combo)*60,a=Math.round(140*t);this.score+=e+r+a,this.flashTile(this.tiles[s],this.colors.good),this.roundsDone>=this.roundsNeeded?this.finish(!0):(this.starsLayer.visible=!0,setTimeout(()=>this.nextRound(),180))}else this.registerMiss("wrong",s)}registerMiss(s,i=null){this.combo=0,this.misses++,this.score=Math.max(0,this.score-150),i!=null&&this.flashTile(this.tiles[i],this.colors.bad);const t=this.tiles[this.correctIndex];this.flashTile(t,this.colors.good,.18),this.misses>this.missesAllowed?this.finish(!1):(this.starsLayer.visible=!0,setTimeout(()=>this.nextRound(),220))}flashTile(s,i,t=.28){const e=new T;e.beginFill(i,t),e.drawRoundedRect(-this.tileW/2,-this.tileH/2,this.tileW,this.tileH,16),e.endFill(),e.x=s.root.x,e.y=s.root.y,this.scene.addChild(e);const r=8;for(let a=1;a<=r;a++)setTimeout(()=>{e.alpha=Math.max(0,t*(1-a/r)),a===r&&this.scene.removeChild(e)},a*30)}drawStars(s){const i=this.app.renderer.width,t=this.app.renderer.height,e=Math.floor(i*.76),r=Math.floor(t*.16),a=Math.floor((i-e)/2),u=Math.floor(t*.36),p=8,f=16;this.starsLayer.removeChildren();for(let c=0;c<s;c++){const l=Math.floor(p+Math.random()*(f-p)),d=a+l+Math.random()*(e-l*2),M=u+l+Math.random()*(r-l*2),w=new T,x=c%3===0?this.colors.star:this.colors.starAlt;this.drawStar(w,d,M,l,x),this.starsLayer.addChild(w)}}drawStar(s,i,t,e,r){const u=e,p=e*.5;s.beginFill(r,1);for(let f=0;f<5*2;f++){const c=Math.PI/5*f-Math.PI/2,l=f%2===0?u:p,d=i+Math.cos(c)*l,M=t+Math.sin(c)*l;f===0?s.moveTo(d,M):s.lineTo(d,M)}s.closePath(),s.endFill()}finish(s){var a;if(this.finished)return;this.finished=!0;const i=Math.round(this.remainMs/8),t=this.roundsDone*60,e=this.misses*120,r=Math.max(0,this.score+i+t-e+(s?700:0));(a=this.onGameEnd)==null||a.call(this,s,r)}}export{P as CountStarGame};
//# sourceMappingURL=CountStarGame-969caf49.js.map
