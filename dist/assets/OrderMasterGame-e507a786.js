var f=Object.defineProperty;var m=(n,r,t)=>r in n?f(n,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[r]=t;var h=(n,r,t)=>(m(n,typeof r!="symbol"?r+"":r,t),t);import{G as g,C as u,a,b as p}from"./index-a4c7ba8a.js";function M(n){return n==="easy"||n==="normal"||n==="hard"}function x(n){const r=n.difficulty;return M(r)?r:"normal"}function b(n,r){return typeof n=="number"&&isFinite(n)?Math.max(1e3,Math.round(n*1e3)):r}function c(n,r,t){return Math.max(r,Math.min(t,n))}function y(n){for(let r=n.length-1;r>0;r--){const t=Math.random()*(r+1)|0;[n[r],n[t]]=[n[t],n[r]]}return n}class F extends g{constructor(t,e){super(t,e);h(this,"onGameEnd");h(this,"scene",new u);h(this,"finished",!1);h(this,"remainMs",3e4);h(this,"cards",[]);h(this,"slots",[]);h(this,"slotX0",0);h(this,"slotY",0);h(this,"slotW",120);h(this,"slotH",160);h(this,"gap",18);h(this,"itemCount",6);h(this,"roundsNeeded",2);h(this,"roundsDone",0);h(this,"score",0);h(this,"combo",0);h(this,"colors",{bgTop:959977,bgBottom:142404,card:16777215,cardEdge:959977,text:1776411,slot:16777215,good:9627303,bad:16734810})}async createScene(){const t=this.settings,e=x(t);this.remainMs=b(t.duration,3e4),e==="easy"?(this.itemCount=5,this.roundsNeeded=1):e==="hard"?(this.itemCount=7,this.roundsNeeded=3):(this.itemCount=6,this.roundsNeeded=2),typeof t.itemCount=="number"&&isFinite(t.itemCount)&&(this.itemCount=c(Math.round(t.itemCount),3,10)),typeof t.rounds=="number"&&isFinite(t.rounds)&&(this.roundsNeeded=c(Math.round(t.rounds),1,6)),t.palette==="warm"?(this.colors.bgTop=16755021,this.colors.bgBottom=5908992,this.colors.cardEdge=16746375):t.palette==="forest"&&(this.colors.bgTop=1332013,this.colors.bgBottom=339478,this.colors.cardEdge=3462041);const s=this.app.renderer.width,o=this.app.renderer.height,i=new a;i.beginFill(this.colors.bgTop),i.drawRect(0,0,s,Math.floor(o*.55)),i.endFill(),i.beginFill(this.colors.bgBottom),i.drawRect(0,Math.floor(o*.55),s,o),i.endFill(),this.scene.addChild(i),this.slotW=Math.min(140,Math.floor((s-80)/this.itemCount)),this.slotH=Math.min(180,Math.floor(o*.42)),this.gap=Math.min(22,Math.max(12,Math.floor((s-this.itemCount*this.slotW)/(this.itemCount+1)))),this.slotY=Math.floor(o*.62),this.slotX0=this.gap+this.slotW/2;for(let l=0;l<this.itemCount;l++){const d=new a;d.lineStyle(3,16777215,.65),d.beginFill(this.colors.slot,.06),d.drawRoundedRect(-this.slotW/2,-this.slotH/2,this.slotW,this.slotH,18),d.endFill(),d.x=this.slotX0+l*(this.slotW+this.gap),d.y=this.slotY,this.scene.addChild(d),this.slots.push(d)}this.generateRound(),this.scene.eventMode="static",this.scene.on("pointerdown",l=>this.onDown(l)),this.scene.on("pointermove",l=>this.onMove(l)),this.scene.on("pointerup",l=>this.onUp(l)),this.scene.on("pointerupoutside",l=>this.onUp(l)),this.container.addChild(this.scene)}handleInput(t){}updateGame(t){if(this.finished)return;const e=t*(1e3/60);if(this.remainMs-=e,this.remainMs<=0){this.remainMs=0,this.finish(!1);return}}showResult(t){var e;(e=this.onGameEnd)==null||e.call(this,t.success,t.score)}generateRound(){for(const e of this.cards)this.scene.removeChild(e.root);this.cards=[];const t=y(Array.from({length:this.itemCount},(e,s)=>s+1));for(let e=0;e<this.itemCount;e++){const s=new u,o=new a;o.beginFill(this.colors.card,1),o.lineStyle(6,this.colors.cardEdge,.95),o.drawRoundedRect(-this.slotW/2,-this.slotH/2,this.slotW,this.slotH,18),o.endFill();const i=new p(String(t[e]),{fontFamily:"sans-serif",fontSize:Math.floor(this.slotH*.48),fill:1776411});i.anchor.set(.5),s.addChild(o,i),s.x=this.slots[e].x,s.y=this.slots[e].y,s.eventMode="static",s.__card__=!0,this.scene.addChild(s),this.cards.push({root:s,bg:o,label:i,value:t[e],slotIndex:e})}}onDown(t){if(this.finished)return;const e=this.scene.toLocal(t.global);for(let s=this.cards.length-1;s>=0;s--){const o=this.cards[s],i=o.root.getBounds();if(e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height){o.dragging=!0,o.dragOffX=e.x-o.root.x,o.dragOffY=e.y-o.root.y,this.scene.removeChild(o.root),this.scene.addChild(o.root);return}}}onMove(t){if(this.finished)return;const e=this.scene.toLocal(t.global);for(const s of this.cards)s.dragging&&(s.root.x=e.x-(s.dragOffX??0),s.root.y=e.y-(s.dragOffY??0))}onUp(t){if(this.finished)return;const e=this.cards.find(o=>o.dragging);if(!e)return;e.dragging=!1;const s=this.nearestSlotIndex(e.root.x);if(this.placeCardAtIndex(e,s),this.isSorted()){this.roundsDone++,this.combo++;const o=800+this.combo*120+Math.round(this.remainMs/12);this.score+=o,this.flashSlots(9627303),this.roundsDone>=this.roundsNeeded?this.finish(!0):setTimeout(()=>this.generateRound(),220)}}nearestSlotIndex(t){let e=0,s=Number.POSITIVE_INFINITY;for(let o=0;o<this.slots.length;o++){const i=Math.abs(this.slots[o].x-t);i<s&&(e=o,s=i)}return e}placeCardAtIndex(t,e){e=c(e,0,this.cards.length-1);const s=this.cards.slice().sort((i,l)=>i.slotIndex-l.slotIndex),o=s.indexOf(t);if(!(o<0)){s.splice(o,1),s.splice(e,0,t);for(let i=0;i<s.length;i++){const l=s[i];l.slotIndex=i,l.root.x=this.slots[i].x,l.root.y=this.slots[i].y}this.cards=s}}isSorted(){for(let t=0;t<this.cards.length;t++){const e=t+1,s=this.cards.find(o=>o.slotIndex===t);if(!s||s.value!==e)return!1}return!0}flashSlots(t){for(const e of this.slots){const s=new a;s.beginFill(t,.28),s.drawRoundedRect(-this.slotW/2,-this.slotH/2,this.slotW,this.slotH,18),s.endFill(),s.x=e.x,s.y=e.y,this.scene.addChild(s);const o=8;for(let i=1;i<=o;i++)setTimeout(()=>{s.alpha=Math.max(0,.28*(1-i/o)),i===o&&this.scene.removeChild(s)},i*30)}}finish(t){var i;if(this.finished)return;this.finished=!0;const e=Math.round(this.remainMs/10),s=this.roundsDone*150,o=Math.max(0,this.score+e+s+(t?800:0));(i=this.onGameEnd)==null||i.call(this,t,o)}}export{F as OrderMasterGame};
//# sourceMappingURL=OrderMasterGame-e507a786.js.map
