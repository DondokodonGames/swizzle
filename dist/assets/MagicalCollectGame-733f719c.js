var k=Object.defineProperty;var D=(a,d,s)=>d in a?k(a,d,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[d]=s;var r=(a,d,s)=>(D(a,typeof d!="symbol"?d+"":d,s),s);import{G as W,C as G,a as p,b as R}from"./index-a4c7ba8a.js";function N(a){return a==="easy"||a==="normal"||a==="hard"}function P(a){const d=a.difficulty;return N(d)?d:"normal"}function S(a,d){return typeof a=="number"&&isFinite(a)?Math.max(1e3,Math.round(a*1e3)):d}function l(a,d,s){return Math.max(d,Math.min(s,a))}class K extends W{constructor(s,n){super(s,n);r(this,"onGameEnd");r(this,"scene",new G);r(this,"finished",!1);r(this,"remainMs",3e4);r(this,"infoText");r(this,"promptText");r(this,"timeBar");r(this,"wand");r(this,"wx",0);r(this,"wy",0);r(this,"wr",34);r(this,"pointerDown",!1);r(this,"spawnAccum",0);r(this,"spawnBaseMs",650);r(this,"speed",160);r(this,"orbs",[]);r(this,"roundsNeeded",8);r(this,"roundsDone",0);r(this,"roundTimeMs",3200);r(this,"roundRemain",3200);r(this,"targetPerRound",8);r(this,"targetKind","fire");r(this,"misses",0);r(this,"missesAllowed",3);r(this,"score",0);r(this,"combo",0);r(this,"colors",{bgTop:3152180,bgBottom:1706782,text:16777215,barBack:3621201,barFill:9133302,wand:16777215,fire:16739179,water:3900150,leaf:3462041,star:16773542,curse:1118481,ring:16569165})}async createScene(){const s=this.settings,n=P(s),h=this.app.renderer.width,o=this.app.renderer.height;this.remainMs=S(s.duration,3e4),n==="easy"?(this.roundsNeeded=6,this.targetPerRound=6,this.roundTimeMs=3600,this.missesAllowed=4,this.spawnBaseMs=720,this.speed=140,this.wr=38):n==="hard"?(this.roundsNeeded=10,this.targetPerRound=9,this.roundTimeMs=2800,this.missesAllowed=2,this.spawnBaseMs=560,this.speed=180,this.wr=30):(this.roundsNeeded=8,this.targetPerRound=8,this.roundTimeMs=3200,this.missesAllowed=3,this.spawnBaseMs=650,this.speed=160,this.wr=34),typeof s.rounds=="number"&&isFinite(s.rounds)&&(this.roundsNeeded=l(Math.round(s.rounds),3,30)),typeof s.targetPerRound=="number"&&isFinite(s.targetPerRound)&&(this.targetPerRound=l(Math.round(s.targetPerRound),2,30)),typeof s.roundTimeMs=="number"&&isFinite(s.roundTimeMs)&&(this.roundTimeMs=l(Math.round(s.roundTimeMs),1200,8e3)),typeof s.missesAllowed=="number"&&isFinite(s.missesAllowed)&&(this.missesAllowed=l(Math.round(s.missesAllowed),0,10)),typeof s.spawnBaseMs=="number"&&isFinite(s.spawnBaseMs)&&(this.spawnBaseMs=l(Math.round(s.spawnBaseMs),200,2e3)),typeof s.speedPxPerSec=="number"&&isFinite(s.speedPxPerSec)&&(this.speed=l(Math.round(s.speedPxPerSec),60,360)),s.palette==="forest"?(this.colors.bgTop=1332013,this.colors.bgBottom=339478,this.colors.barFill=3462041):s.palette==="arcane"?(this.colors.bgTop=1909819,this.colors.bgBottom=790560,this.colors.barFill=9133302):s.palette==="night"&&(this.colors.bgTop=725024,this.colors.bgBottom=1382955,this.colors.barFill=3900150);const t=new p;t.beginFill(this.colors.bgTop),t.drawRect(0,0,h,Math.floor(o*.45)),t.endFill(),t.beginFill(this.colors.bgBottom),t.drawRect(0,Math.floor(o*.45),h,o),t.endFill(),this.scene.addChild(t),this.infoText=new R("",{fontFamily:"sans-serif",fontSize:Math.floor(Math.min(h,o)*.045),fill:this.colors.text,stroke:0,strokeThickness:4}),this.infoText.anchor.set(.5),this.infoText.x=h/2,this.infoText.y=Math.floor(o*.18),this.scene.addChild(this.infoText),this.updateInfo(),this.promptText=new R("Ready?",{fontFamily:"sans-serif",fontSize:Math.floor(Math.min(h,o)*.08),fill:this.colors.text,stroke:0,strokeThickness:6}),this.promptText.anchor.set(.5),this.promptText.x=h/2,this.promptText.y=Math.floor(o*.28),this.scene.addChild(this.promptText),this.timeBar=new p,this.scene.addChild(this.timeBar),this.wx=h/2,this.wy=Math.floor(o*.7),this.wand=new p,this.drawWand(),this.scene.addChild(this.wand),this.scene.eventMode="static",this.scene.on("pointerdown",i=>{this.pointerDown=!0;const e=this.scene.toLocal(i.global);this.wx=e.x,this.wy=e.y,this.drawWand()}),this.scene.on("pointermove",i=>{if(!this.pointerDown)return;const e=this.scene.toLocal(i.global);this.wx=e.x,this.wy=e.y,this.clampWand(),this.drawWand()}),this.scene.on("pointerup",()=>{this.pointerDown=!1}),this.scene.on("pointerupoutside",()=>{this.pointerDown=!1}),this.container.addChild(this.scene),this.nextRound(!0)}handleInput(s){}updateGame(s){if(this.finished)return;const n=s*(1e3/60),h=n/1e3,o=this.app.renderer.width,t=this.app.renderer.height;if(this.remainMs-=n,this.remainMs<=0){this.remainMs=0,this.finish(this.roundsDone>=this.roundsNeeded);return}for(this.roundRemain-=n,this.roundRemain<=0&&this.registerMiss("timeout"),this.spawnAccum+=n;this.spawnAccum>=this.spawnBaseMs;)this.spawnAccum-=this.spawnBaseMs,this.spawnOrb();const i=[];for(const e of this.orbs){e.x+=e.vx*h,e.y+=e.vy*h,e.x-e.r<6&&(e.x=e.r+6,e.vx=Math.abs(e.vx)),e.x+e.r>o-6&&(e.x=o-e.r-6,e.vx=-Math.abs(e.vx)),e.y-e.r<Math.floor(t*.4)&&(e.y=Math.floor(t*.4)+e.r,e.vy=Math.abs(e.vy)),e.y+e.r>t-10&&(e.y=t-10-e.r,e.vy=-Math.abs(e.vy));const c=e.x-this.wx,f=e.y-this.wy;if(Math.sqrt(c*c+f*f)<=e.r+this.wr){this.onCollect(e);continue}performance.now()-e.bornAt<12e3?i.push(e):this.scene.removeChild(e.g)}this.orbs=i,this.drawTimeBar()}showResult(s){var n;(n=this.onGameEnd)==null||n.call(this,s.success,s.score)}updateInfo(){const s=Math.ceil(this.remainMs/1e3);this.infoText.text=`Round ${this.roundsDone}/${this.roundsNeeded}   Miss ${this.misses}/${this.missesAllowed}   Time ${s}s`}drawTimeBar(){const s=this.app.renderer.width,n=Math.floor(this.app.renderer.height*.36),h=Math.floor(s*.7),o=Math.floor((s-h)/2),t=10,i=l(this.roundRemain/this.roundTimeMs,0,1);this.timeBar.clear(),this.timeBar.beginFill(this.colors.barBack,.4),this.timeBar.drawRoundedRect(o,n,h,t,6),this.timeBar.endFill(),this.timeBar.beginFill(this.colors.barFill,.95),this.timeBar.drawRoundedRect(o,n,Math.floor(h*i),t,6),this.timeBar.endFill()}drawWand(){const s=this.wand;s.clear(),s.lineStyle(4,this.colors.ring,.9),s.drawCircle(this.wx,this.wy,this.wr),s.endFill(),s.beginFill(this.colors.wand,.6),s.drawCircle(this.wx,this.wy,Math.max(6,Math.floor(this.wr*.18))),s.endFill()}clampWand(){const s=this.app.renderer.width,n=this.app.renderer.height,h=Math.floor(n*.4);this.wx=l(this.wx,this.wr+6,s-this.wr-6),this.wy=l(this.wy,h+this.wr+6,n-this.wr-8)}nextRound(s=!1){const n=["fire","water","leaf","star"];this.targetKind=n[Math.random()*n.length|0],this.promptText.text=`Collect ${this.targetKind.toUpperCase()} Ã— ${this.targetPerRound}`,this.roundRemain=this.roundTimeMs,this.combo=0;for(const h of this.orbs)this.scene.removeChild(h.g);this.orbs=[],s||this.updateInfo(),this.drawTimeBar()}spawnOrb(){const s=this.app.renderer.width,n=this.app.renderer.height,h=Math.random();let o;if(h<.45)o=this.targetKind;else if(h<.8){const m=["fire","water","leaf","star"].filter(M=>M!==this.targetKind);o=m[Math.random()*m.length|0]}else o="curse";const t=new p,i=16+Math.random()*10;if(o==="fire")t.beginFill(this.colors.fire,.95),t.drawCircle(0,0,i),t.endFill(),t.beginFill(16777215,.6),t.drawCircle(i*.2,-i*.2,i*.35),t.endFill();else if(o==="water")t.beginFill(this.colors.water,.95),t.drawEllipse(0,0,i*.86,i),t.endFill();else if(o==="leaf")t.beginFill(this.colors.leaf,.95),t.drawPolygon([-i,0,0,-i*.9,i,0,0,i*.9]),t.endFill();else if(o==="star"){t.beginFill(this.colors.star,.95);const m=5,M=i,A=i*.5;for(let u=0;u<m*2;u++){const y=Math.PI/m*u-Math.PI/2,T=u%2===0?M:A,F=Math.cos(y)*T,B=Math.sin(y)*T;u===0?t.moveTo(F,B):t.lineTo(F,B)}t.closePath(),t.endFill()}else t.beginFill(this.colors.curse,.95),t.drawPolygon([-i,-i,i,-i,i,i,-i,i]),t.endFill();const e=12,c=Math.floor(n*.42),f=n-14;let w=e+Math.random()*(s-e*2),g=c+Math.random()*(f-c);t.x=w,t.y=g,this.scene.addChild(t);const x=Math.random()*Math.PI*2,b=this.speed*(.7+Math.random()*.6),C=Math.cos(x)*b,v=Math.sin(x)*b;this.orbs.push({g:t,x:w,y:g,r:i,vx:C,vy:v,kind:o,bornAt:performance.now()})}onCollect(s){if(this.scene.removeChild(s.g),s.kind===this.targetKind){this.targetPerRound--,this.combo++;const n=l(this.roundRemain/this.roundTimeMs,0,1),h=120,o=Math.min(10,this.combo)*20,t=Math.round(60*n);if(this.score+=h+o+t,this.flash(this.wx,this.wy,9627303),this.targetPerRound<=0)if(this.roundsDone++,this.roundsDone>=this.roundsNeeded)this.finish(!0);else{const i=this.settings,e=P(i),c=e==="easy"?6:e==="hard"?9:8,f=typeof i.targetPerRound=="number"&&isFinite(i.targetPerRound)?l(Math.round(i.targetPerRound),2,30):c;this.targetPerRound=f,setTimeout(()=>this.nextRound(),180)}}else this.registerMiss(s.kind==="curse"?"curse":"wrong")}registerMiss(s){this.combo=0,this.misses++,this.score=Math.max(0,this.score-150),this.flash(this.wx,this.wy,16734810),this.misses>this.missesAllowed?this.finish(!1):setTimeout(()=>this.nextRound(),220)}flash(s,n,h){const o=new p;o.beginFill(h,.22),o.drawCircle(0,0,this.wr*1.6),o.endFill(),o.x=s,o.y=n,this.scene.addChild(o);const t=8;for(let i=1;i<=t;i++)setTimeout(()=>{o.alpha=Math.max(0,.22*(1-i/t)),i===t&&this.scene.removeChild(o)},i*30)}finish(s){var i;if(this.finished)return;this.finished=!0;const n=Math.round(this.remainMs/6),h=this.roundsDone*60,o=this.misses*120,t=Math.max(0,this.score+n+h-o+(s?800:0));(i=this.onGameEnd)==null||i.call(this,s,t)}}export{K as MagicalCollectGame};
//# sourceMappingURL=MagicalCollectGame-733f719c.js.map
