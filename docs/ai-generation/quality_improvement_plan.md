# 品質問題の根本原因と改善計画

**作成日**: 2025-12-19
**Phase**: 2-1, 2-2
**目的**: 250本破棄の原因特定と高品質生成フローの設計

---

## 1. 250本破棄の原因分析

### 1.1 推定される主要原因

Phase 1の分析結果から、以下が250本破棄の主要原因と推定されます:

| 原因 | 確信度 | 影響度 | 説明 |
|------|--------|--------|------|
| **GameSpec生成の仮実装** | 95% | 致命的 | ランダム組み合わせで面白いゲームが生まれない |
| **面白さ基準の欠如** | 90% | 重大 | 「動くか」は検証できるが「面白いか」は判定できない |
| **音声生成の未実装** | 85% | 重大 | 無音ゲームは体験が不完全 |
| **ビジュアル品質不足** | 80% | 中程度 | 単色SVGでは魅力に欠ける |
| **ルール生成の失敗** | 70% | 中程度 | 不正なJSONや動作しないルール |

### 1.2 各原因の詳細

#### 原因1: GameSpec生成の仮実装（確信度95%）

**現状のコード（MasterOrchestrator.ts）**:
```typescript
// TODO: 本実装ではClaude APIでゲーム仕様を生成
// 現在はランダムに組み合わせを生成
const genres: GameGenre[] = ['action', 'puzzle', 'timing', ...];
const mechanics: GameMechanic[] = ['tap', 'swipe', 'drag', ...];
```

**問題点**:
- ジャンルとメカニクスをランダム選択するだけ
- ゲームコンセプトや世界観がない
- 「面白さ」を考慮した設計がない

**影響**:
- 生成されるGameSpecが「何が面白いのか」不明確
- LogicGeneratorがまともなルールを生成できない
- 結果として動くけど面白くないゲームが量産

#### 原因2: 面白さ基準の欠如（確信度90%）

**現状のDynamicQualityChecker**:
```typescript
// 相対評価（50点）: 多様性・密度・ギャップ・バランス
// 絶対評価（45点）: 基本品質・プレイアビリティ・満足度予測
```

**問題点**:
- 「多様性」は面白さではない
- 「プレイアビリティ」はクリア可能性であり面白さではない
- 「満足度予測」は曖昧で実装がルールベース

**影響**:
- 動作するが面白くないゲームが合格してしまう
- 面白いゲームと面白くないゲームの区別ができない

#### 原因3: 音声生成の未実装（確信度85%）

**現状のSoundGenerator**:
```typescript
// TODO: 実装
return { bgm: null, sounds: [] };
```

**問題点**:
- 全てのゲームが無音
- タップ時のフィードバックがない
- 達成感や失敗の演出が弱い

**影響**:
- ゲーム体験が大幅に低下
- 「面白くない」という印象の一因

---

## 2. 根本原因の構造

```
┌─────────────────────────────────────────────────────────┐
│           根本原因: 「面白さ」の定義と評価がない           │
└─────────────────────────────────────────────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│ GameSpec生成  │  │  品質チェック  │  │ アセット生成  │
│ が貧弱       │  │ に面白さ基準  │  │ が貧弱       │
│              │  │ がない        │  │              │
└───────────────┘  └───────────────┘  └───────────────┘
        │                  │                  │
        ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────┐
│       動くけど面白くないゲームが量産される                 │
└─────────────────────────────────────────────────────────┘
```

---

## 3. 改善方針

### 3.1 設計原則

1. **面白さファースト**: 動作よりも面白さを優先
2. **検証可能な品質**: 数値化・自動判定できる品質基準
3. **多様性の確保**: 1000本が全て異なるゲームであること
4. **並列処理**: 速度のために並列生成必須
5. **ハードコードOK**: Swizzle JSONに固執しない

### 3.2 改善アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│           新: GameIdeaGenerator（GPT-4/Claude）          │
│  面白いゲームアイデアを生成し、自己評価で7点以上を確保      │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│           新: FunValidator（Claude）                     │
│  生成されたアイデアの面白さを客観的に評価                  │
└─────────────────────────────────────────────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│ 改善:         │  │ 改善:         │  │ 新:           │
│ ImageGenerator│  │ LogicGenerator│  │ SoundGenerator│
│ (高品質指示)  │  │ (パターン参照)│  │ (実装する)    │
└───────────────┘  └───────────────┘  └───────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│           改善: QualityChecker                          │
│  面白さスコア + 動作確認 + 多様性チェック                 │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│           並列実行: ParallelExecutor                    │
│  50並列で1000本を20分で生成                              │
└─────────────────────────────────────────────────────────┘
```

---

## 4. 新コンポーネント設計

### 4.1 GameIdeaGenerator

**役割**: 面白いゲームアイデアを生成

**入力**: なし（完全ユニーク生成）

**出力**: GameIdea

```typescript
interface GameIdea {
  title: string;
  description: string;
  theme: string;           // 世界観（宇宙、森、海など）
  mainMechanic: string;    // メインの操作（タップ連打、タイミング、etc）
  subMechanics: string[];  // サブの操作
  winCondition: string;    // 勝利条件
  loseCondition: string;   // 敗北条件
  duration: number;        // ゲーム時間（秒）
  difficulty: 'easy' | 'normal' | 'hard';
  funScore: number;        // 自己評価（1-10）
  uniqueness: string;      // 他ゲームとの差別化ポイント
  visualStyle: string;     // ビジュアルスタイル
}
```

**プロンプト設計**:
```
あなたは10秒ゲームのプロデューサーです。

# 要件
- 10秒で完結する面白いゲームを考案
- スマホ縦画面（1080×1920px）
- タッチ操作のみ
- 既存の{existingGames}とは異なるゲーム

# 面白さの基準
1. 目標が明確（何をすればいいか一目でわかる）
2. 操作が簡単（タップ/スワイプのみ）
3. 達成感がある（成功時に爽快）
4. 適度な緊張感（失敗もありえる）
5. リプレイ価値（もう一度やりたい）

# 禁止パターン
- 静的なオブジェクトをただタップするだけ
- 答えが1つしかないクイズ
- ランダム運ゲー

# 出力形式
JSON形式で出力してください。
funScoreは1-10で自己評価し、7未満の場合は再考してください。
```

### 4.2 FunValidator

**役割**: アイデアの面白さを客観評価

**入力**: GameIdea

**出力**: FunValidationResult

```typescript
interface FunValidationResult {
  overallScore: number;     // 総合スコア（1-10）
  clarity: number;          // 目標の明確さ（1-10）
  engagement: number;       // 没入感（1-10）
  replayValue: number;      // リプレイ価値（1-10）
  uniqueness: number;       // ユニークさ（1-10）
  feasibility: number;      // 実装可能性（1-10）
  feedback: string;         // 改善フィードバック
  approved: boolean;        // 合格判定（7点以上）
}
```

### 4.3 ImprovedLogicGenerator

**改善点**:
1. Phase 1-2の仕様書を参照
2. 動作確認済みパターンのみ使用
3. サンプルゲームを参考例として提示
4. 速度パラメータの推奨値を明示

**プロンプト追加内容**:
```
# 動作確認済みパターン
以下のパターンは動作確認済みです。これらを組み合わせて使用してください：

## パターン1: タップカウント
{パターン1のコード}

## パターン2: 移動 + タップ
{パターン2のコード}

## パターン3: 衝突判定
{パターン3のコード}

# 速度パラメータ
- 遅い: 1.0-2.0
- 普通: 2.0-4.0
- 速い: 4.0-8.0

# 禁止事項
- 未検証の条件タイプを使用しない
- 10ルール以上にしない
- 物理演算を多用しない
```

### 4.4 ImprovedSoundGenerator

**新規実装**:
- Web Audio API + Tone.jsを活用
- 最低限の効果音セット:
  - タップ音
  - 成功音
  - 失敗音
  - BGM（オプション）

**実装方針**:
```typescript
class ImprovedSoundGenerator {
  // 効果音テンプレート（Base64）
  private readonly SOUND_TEMPLATES = {
    tap: 'data:audio/wav;base64,...',
    success: 'data:audio/wav;base64,...',
    failure: 'data:audio/wav;base64,...',
    bgm_happy: 'data:audio/wav;base64,...',
    bgm_exciting: 'data:audio/wav;base64,...',
  };

  async generate(idea: GameIdea): Promise<SoundAssets> {
    // テーマに基づいてBGMを選択
    const bgm = this.selectBGM(idea.theme);

    // 基本効果音セット
    const sounds = [
      { id: 'tap', data: this.SOUND_TEMPLATES.tap },
      { id: 'success', data: this.SOUND_TEMPLATES.success },
      { id: 'failure', data: this.SOUND_TEMPLATES.failure },
    ];

    return { bgm, sounds };
  }
}
```

### 4.5 ImprovedQualityChecker

**改善点**:
1. 面白さスコアの追加
2. 動作テストの強化
3. 多様性チェックの高速化

**新しい評価基準**:
```typescript
interface QualityScore {
  // 面白さ（40点）
  funScore: {
    clarity: number;       // 0-10: 目標の明確さ
    engagement: number;    // 0-10: 没入感
    dynamics: number;      // 0-10: 動的要素
    feedback: number;      // 0-10: フィードバック（演出）
  };

  // 動作確認（30点）
  functionality: {
    rulesWork: number;     // 0-10: ルールが動作する
    winnable: number;      // 0-10: クリア可能
    balanced: number;      // 0-10: バランスが取れている
  };

  // 多様性（30点）
  diversity: {
    uniqueMechanic: number; // 0-10: メカニクスのユニークさ
    uniqueVisual: number;   // 0-10: ビジュアルのユニークさ
    uniqueTheme: number;    // 0-10: テーマのユニークさ
  };

  total: number;  // 100点満点
  approved: boolean;  // 70点以上で合格
}
```

---

## 5. 生成フロー（改善版）

### 5.1 フロー図

```
開始
  │
  ▼
┌─────────────────────────────────────────────────────────┐
│ Step 1: GameIdeaGenerator                               │
│ - GPT-4/Claudeでアイデア生成                            │
│ - 自己評価7点以上を要求                                 │
│ - 既存ゲームとの重複チェック                            │
└─────────────────────────────────────────────────────────┘
  │ 7点未満 → 再生成（最大3回）
  ▼
┌─────────────────────────────────────────────────────────┐
│ Step 2: FunValidator                                    │
│ - 別AIで面白さを客観評価                                │
│ - 7点以上で通過                                         │
└─────────────────────────────────────────────────────────┘
  │ 7点未満 → 破棄、Step 1に戻る
  ▼
┌─────────────────────────────────────────────────────────┐
│ Step 3: 並列アセット生成                                │
│ - ImageGenerator: 背景 + オブジェクト                   │
│ - SoundGenerator: BGM + 効果音                          │
└─────────────────────────────────────────────────────────┘
  │
  ▼
┌─────────────────────────────────────────────────────────┐
│ Step 4: LogicGenerator                                  │
│ - 仕様書参照でルール生成                                │
│ - 動作確認済みパターン使用                              │
└─────────────────────────────────────────────────────────┘
  │
  ▼
┌─────────────────────────────────────────────────────────┐
│ Step 5: QualityChecker                                  │
│ - 面白さ + 動作 + 多様性 = 100点                        │
│ - 70点以上で合格                                        │
└─────────────────────────────────────────────────────────┘
  │ 70点未満 → Step 1に戻る
  ▼
┌─────────────────────────────────────────────────────────┐
│ Step 6: 保存・公開                                      │
└─────────────────────────────────────────────────────────┘
  │
  ▼
完了
```

### 5.2 期待される改善効果

| 指標 | 現状 | 改善後 |
|------|------|--------|
| 合格率 | ~5% | ~50% |
| 面白いゲーム率 | ~2% | ~35% |
| 生成速度 | 5分/本 | 1分/本 |
| 1000本生成時間 | 83時間 | 40分 |
| 1000本コスト | $2000 | $500-700 |

---

## 6. 実装優先順位

### Phase 3-1: 最優先改善（1-2時間）

1. **GameIdeaGenerator新規実装**
   - GPT-4/Claude APIで面白いアイデア生成
   - 自己評価機能

2. **SoundGenerator実装**
   - 最低限の効果音テンプレート
   - Base64埋め込み

### Phase 3-2: 品質向上（2-3時間）

3. **LogicGenerator改善**
   - 仕様書参照の追加
   - パターン集の組み込み

4. **QualityChecker改善**
   - 面白さスコア追加
   - 評価基準の明確化

### Phase 3-3: 速度向上（1-2時間）

5. **ParallelExecutor新規実装**
   - 50並列実行
   - エラーハンドリング

6. **統合テスト**
   - 10本生成テスト
   - 品質確認

---

## 7. 次のステップ

Phase 2-3（コスト・速度最適化）に進み、以下を設計します：

1. API呼び出しの最適化
2. キャッシュ戦略
3. 並列度の調整
4. コスト削減策
